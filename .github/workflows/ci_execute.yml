name: 01-Cã¨C++ãƒ“ãƒ«ãƒ‰CI (Dockerç‰ˆ è‡ªãƒ›ã‚¹ãƒˆå®Ÿè¡Œ)

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: [self-hosted, home-runner]

    steps:
      - name: "Step0: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ"
        uses: actions/checkout@v4

      - name: "Step1: Dockerã‚³ãƒ³ãƒ†ãƒŠå†…ã§ãƒ“ãƒ«ãƒ‰ä¸€å¼ã‚’å®Ÿè¡Œ"
        run: |
          docker run --rm \
            -u $(id -u):$(id -g) \
            -v $PWD:/workspace \
            -w /workspace \
            ghcr.io/sinsan0209/devops-ci-image:latest \
            bash -c '
              echo "::group::ğŸ§­ OSæƒ…å ±"
              uname -a
              cat /etc/os-release
              echo "::endgroup::"

              echo "::group::ğŸ› ï¸ ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‚¸ãƒ§ãƒ³"
              gcc --version
              g++ --version
              bazel --version
              echo "::endgroup::"

              echo "â–¶ï¸ ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ"
              ./scripts/test.sh

              echo "â–¶ï¸ ãƒ“ãƒ«ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ"
              mkdir -p build

              echo "â–¶ï¸ Cãƒ“ãƒ«ãƒ‰"
              gcc -o build/hello src/hello.c

              echo "â–¶ï¸ Cå®Ÿè¡Œ"
              ./build/hello

              echo "â–¶ï¸ C++ãƒ“ãƒ«ãƒ‰"
              g++ -o build/hello_cpp src/hello.cpp

              echo "â–¶ï¸ C++å®Ÿè¡Œ"
              ./build/hello_cpp

              echo "â–¶ï¸ Bazelãƒ“ãƒ«ãƒ‰"
              cd bazel_sample
              bazel build //main:hello

              echo "â–¶ï¸ Bazelæˆæœç‰©ã‚’å®Ÿè¡Œ"
              ./bazel-bin/main/hello

              echo "â–¶ï¸ Bazelãƒ†ã‚¹ãƒˆ"
              bazel test --test_output=all //main:hello_test

              echo "âœ… æˆæœç‰©ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤"
              mkdir -p /workspace/deploy_area
              cp bazel-bin/main/hello /workspace/deploy_area/
            '

      - name: "Step2: æˆæœç‰©ã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜"
        uses: actions/upload-artifact@v4
        with:
          name: built-hello-binaries
          path: |
            build/hello
            build/hello_cpp
            deploy_area/hello

      - name: "Step3: å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"
        run: |
          echo "::group::ğŸš€ å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"
          echo "ğŸ‰ å…¨ãƒ“ãƒ«ãƒ‰ã¨ãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚‚ä¿å­˜æ¸ˆã¿ã§ã™ã€‚"
          echo "::endgroup::"

name: 01-Cã¨C++ãƒ“ãƒ«ãƒ‰CI (Dockerç‰ˆ)

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: [self-hosted, ubuntu]
    container:
      image: ghcr.io/sinsan0209/devops-ci-image:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      options: --volume /home/ubuntu/workspace/devops:/mnt/devops

    steps:
      - name: "Step0: ç’°å¢ƒã®ç¢ºèª"
        run: |
          echo "::group::ğŸ§­ OSæƒ…å ±"
          uname -a
          cat /etc/os-release
          echo "::endgroup::"

          echo "::group::ğŸ› ï¸ ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‚¸ãƒ§ãƒ³"
          gcc --version
          g++ --version
          bazel --version
          echo "::endgroup::"

      - name: "Step1: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ!"
        uses: actions/checkout@v4

      - name: "Step2: ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œï¼ˆtest.shï¼‰"
        run: ./scripts/test.sh

      - name: "Step3: ãƒ“ãƒ«ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ"
        run: mkdir -p build

      - name: "Step4: Cã‚³ãƒ¼ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰ï¼ˆhello.cï¼‰"
        run: gcc -o build/hello src/hello.c

      - name: "Step5: Cæˆæœç‰©ã‚’å®Ÿè¡Œ"
        run: ./build/hello

      - name: "Step6: C++ã‚³ãƒ¼ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰ï¼ˆhello.cppï¼‰"
        run: g++ -o build/hello_cpp src/hello.cpp

      - name: "Step7: C++æˆæœç‰©ã‚’å®Ÿè¡Œ"
        run: ./build/hello_cpp

      - name: "Step8: Bazelãƒ“ãƒ«ãƒ‰ï¼ˆhelloï¼‰"
        run: |
          export USER=ubuntu
          cd bazel_sample
          bazel build //main:hello

      - name: "Step9: Bazelæˆæœç‰©ã‚’å®Ÿè¡Œ"
        run: |
          export USER=ubuntu
          cd bazel_sample
          ./bazel-bin/main/hello

      - name: "Step10: Bazelã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
        run: |
          export USER=ubuntu
          cd bazel_sample
          bazel test --test_output=all //main:hello_test

      - name: "Step11: æˆæœç‰©ã‚’ãƒ›ã‚¹ãƒˆã«ãƒ‡ãƒ—ãƒ­ã‚¤"
        if: success()
        run: |
          mkdir -p /mnt/devops/artifacts
          cp bazel_sample/bazel-bin/main/hello /mnt/devops/artifacts/
          cp build/hello /mnt/devops/artifacts/
          cp build/hello_cpp /mnt/devops/artifacts/
          echo "âœ… ãƒ›ã‚¹ãƒˆã® ~/workspace/devops/artifacts ã«æˆæœç‰©ã‚’å‡ºåŠ›ã—ã¾ã—ãŸ"

      - name: "Step11-fail: ãƒ†ã‚¹ãƒˆå¤±æ•—ã®ãŸã‚ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã‚¹ã‚­ãƒƒãƒ—"
        if: failure()
        run: echo "âŒ ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ãŸãŸã‚ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ"

      - name: "Step12: Bazelã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªãƒ¼ãƒ³ï¼ˆæœ€å¾Œã«ï¼‰"
        run: |
          export USER=ubuntu
          cd bazel_sample
          bazel clean

      - name: "Step13: æˆæœç‰©ã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜"
        uses: actions/upload-artifact@v4
        with:
          name: built-hello-binaries
          path: |
            build/hello
            build/hello_cpp
            bazel_sample/bazel-bin/main/hello

      - name: "Step14: å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"
        run: |
          echo "::group::ğŸš€ å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"
          echo "ğŸ‰ å…¨ãƒ“ãƒ«ãƒ‰ã¨ãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚‚ä¿å­˜æ¸ˆã¿ã§ã™ã€‚"
          echo "::endgroup::"

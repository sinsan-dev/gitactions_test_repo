name: 01-Cã¨C++ãƒ“ãƒ«ãƒ‰CI (Dockeræ‰‹å‹•èµ·å‹•ç‰ˆ)

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: [self-hosted, home-runner]

    steps:
      - name: "Step1: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ"
        uses: actions/checkout@v4

      - name: "Step2: Dockerã‚³ãƒ³ãƒ†ãƒŠå†…ã§ãƒ“ãƒ«ãƒ‰ä¸€å¼ã‚’å®Ÿè¡Œ"
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ghcr.io/sinsan0209/devops-ci-image:latest \
            bash -c '
              echo "::group::ğŸ§­ OSæƒ…å ±"
              uname -a
              cat /etc/os-release
              echo "::endgroup::"

              echo "::group::ğŸ› ï¸ ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‚¸ãƒ§ãƒ³"
              gcc --version
              g++ --version
              bazel --version
              echo "::endgroup::"

              ./scripts/test.sh

              mkdir -p build

              gcc -o build/hello src/hello.c
              ./build/hello

              g++ -o build/hello_cpp src/hello.cpp
              ./build/hello_cpp

              cd bazel_sample
              bazel build //main:hello
              ./bazel-bin/main/hello
              bazel test --test_output=all //main:hello_test

              if [ $? -eq 0 ]; then
                mkdir -p /workspace/deploy_area
                cp bazel-bin/main/hello /workspace/deploy_area/
                echo "âœ… æˆæœç‰©ã‚’ deploy_area ã«ã‚³ãƒ”ãƒ¼å®Œäº†"
              else
                echo "âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚­ãƒƒãƒ—"
              fi

              bazel clean
            '

      - name: "Step3: æˆæœç‰©ã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜"
        uses: actions/upload-artifact@v4
        with:
          name: built-hello-binaries
          path: |
            build/hello
            build/hello_cpp
            deploy_area/hello

      - name: "Step4: å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"
        run: |
          echo "::group::ğŸš€ å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"
          echo "ğŸ‰ å…¨ãƒ“ãƒ«ãƒ‰ã¨ãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚‚ä¿å­˜æ¸ˆã¿ã§ã™ã€‚"
          echo "::endgroup::"

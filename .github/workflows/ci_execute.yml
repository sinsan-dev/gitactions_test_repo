name: 01-Cã¨C++ãƒ“ãƒ«ãƒ‰CI

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: self-hosted

    steps:
      - name: "Step1: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ"
        uses: actions/checkout@v4

      - name: "Step2: ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œï¼ˆtest.shï¼‰"
        run: ./scripts/test.sh

      - name: "Step3: ãƒ“ãƒ«ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ"
        run: mkdir -p build

      - name: "Step4: Cã‚³ãƒ¼ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰ï¼ˆhello.cï¼‰"
        run: gcc -o build/hello src/hello.c

      - name: "Step5: Cæˆæœç‰©ã‚’å®Ÿè¡Œ"
        run: ./build/hello

      - name: "Step6: C++ã‚³ãƒ¼ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰ï¼ˆhello.cppï¼‰"
        run: g++ -o build/hello_cpp src/hello.cpp

      - name: "Step7: C++æˆæœç‰©ã‚’å®Ÿè¡Œ"
        run: ./build/hello_cpp

      - name: "Step8: Bazelãƒ“ãƒ«ãƒ‰ï¼ˆhelloï¼‰"
        run: |
          cd bazel_sample
          bazel build //main:hello

      - name: "Step9: Bazelæˆæœç‰©ã‚’å®Ÿè¡Œ"
        run: |
          cd bazel_sample
          ./bazel-bin/main/hello

      - name: "Step9.5: Bazelã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªãƒ¼ãƒ³"
        run: |
          cd bazel_sample
          bazel clean

      - name: "Step10: Bazelã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
        id: bazel_test_result
        run: |
          cd bazel_sample
          bazel test --test_output=all //main:hello_test

      - name: "Step11: æˆæœç‰©ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆã‚‚ã©ãï¼‰â€»ãƒ†ã‚¹ãƒˆæˆåŠŸæ™‚ã®ã¿"
        if: success()
        run: |
          cd bazel_sample
          BIN_PATH=$(bazel info bazel-bin)/main/hello
          echo "ğŸ” æˆæœç‰©ã®ãƒ‘ã‚¹: $BIN_PATH"
          if [ -f "$BIN_PATH" ]; then
            mkdir -p ~/deploy_area
            cp "$BIN_PATH" ~/deploy_area/
            echo "âœ… æˆæœç‰©ã‚’ ~/deploy_area ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"
          else
            echo "âš ï¸ æˆæœç‰©ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã§ã—ãŸ: $BIN_PATH"
            exit 1
          fi

      - name: "Step11-fail: ãƒ†ã‚¹ãƒˆå¤±æ•—ã®ãŸã‚ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã‚¹ã‚­ãƒƒãƒ—"
        if: failure()
        run: echo "âŒ ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ãŸãŸã‚ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ"

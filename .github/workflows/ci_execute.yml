name: 01-CとC++ビルドCI

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: self-hosted

    steps:
      - name: "Step1: リポジトリをチェックアウト"
        uses: actions/checkout@v4

      - name: "Step2: シェルスクリプトを実行（test.sh）"
        run: ./scripts/test.sh

      - name: "Step3: ビルドディレクトリ作成"
        run: mkdir -p build

      - name: "Step4: Cコードをビルド（hello.c）"
        run: gcc -o build/hello src/hello.c

      - name: "Step5: C成果物を実行"
        run: ./build/hello

      - name: "Step6: C++コードをビルド（hello.cpp）"
        run: g++ -o build/hello_cpp src/hello.cpp

      - name: "Step7: C++成果物を実行"
        run: ./build/hello_cpp

      - name: "Step8: Bazelビルド（hello）"
        run: |
          cd bazel_sample
          bazel build //main:hello

      - name: "Step9: Bazel成果物を実行"
        run: |
          cd bazel_sample
          ./bazel-bin/main/hello

      - name: "Step10: Bazelでテスト実行"
        id: bazel_test_result
        run: |
          cd bazel_sample
          bazel test --test_output=all //main:hello_test

      - name: "Step11: 成果物をデプロイ（もどき）※テスト成功時のみ"
        if: success()
        run: |
          mkdir -p ~/deploy_area
          cp bazel_sample/bazel-bin/main/hello ~/deploy_area/
          echo "✅ 成果物を ~/deploy_area にコピー完了しました"

      - name: "Step11-fail: テスト失敗のためデプロイをスキップ"
        if: failure()
        run: echo "❌ テストが失敗したため、デプロイはスキップされました"

      - name: "Step12: Bazelキャッシュをクリーン（最後に）"
        run: |
          cd bazel_sample
          bazel clean
